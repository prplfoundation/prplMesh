build-in-docker:
  stage: build
  image:
    name: prplfoundationinc/prplmesh-builder:ubuntu-18.04
    entrypoint: [""]
  variables:
    CMAKE_BUILD_TYPE: "Release"
  script:
    # Run clang-format and check there are no modified files by checking git status
    - ./clang-format.sh
    - git diff-index --exit-code HEAD
    - cmake -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DCMAKE_INSTALL_PREFIX=build/install -H. -Bbuild -G Ninja
    - ninja -C build install
    # Check that the AutoGenerated files are correct by checking git status
    - git update-index -q --refresh
    - git diff-index --exit-code HEAD

  artifacts:
    paths:
      - build/install
  tags:
    - docker

run-tests:
  stage: test
  image: $CI_REGISTRY_IMAGE/tests-runner:18.09.7-dind
  script:
    - cd tools/docker
    # Try to pull from dockerhub, build the container images if that fails
    - ./image-pull.sh || ./image-build.sh
    - ./run.sh -f --entrypoint "$PWD/../../build/install/bin/tests/tlvf_test"
    - ./tests/test_flows.sh -v

  artifacts:
    paths:
      - logs
    when: always

  tags:
    - docker
    - docker-build

  after_script:
    - tools/docker/stop.sh -k -r
  needs:
    - job: build-in-docker

.build-for-openwrt:
  stage: build
  script:
    - cd tools/docker/builder/openwrt
    - ./build.sh targets/$TARGET.args 2>&1 | tee build.log | grep -E '^make\[[12]\]|^Step' --color=never --line-buffered
  artifacts:
    paths:
      - tools/docker/builder/openwrt/*.ipk
      - tools/docker/builder/openwrt/build.log
    when: always
  tags:
    - shell
    - docker-build

.test-on-target:
  stage: test
  script:
    - tools/deploy_ipk.sh $TARGET_DEVICE tools/docker/builder/openwrt/*.ipk
    - tools/docker/tests/openwrt/test_status.sh $TARGET_DEVICE
  tags:
    - targets

build-for-turris-omnia:
  extends: .build-for-openwrt
  variables:
    TARGET: turris-omnia

test-on-turris-omnia:
  extends: .test-on-target
  variables:
    TARGET_DEVICE: turris-omnia-1
  needs: ["build-for-turris-omnia"]
