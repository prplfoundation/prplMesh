before_script:
  # check the availability of some commands:
  - command >/dev/null -v python3 jq

after_script:
  - tools/docker/stop.sh -k -r

build-in-docker:
  stage: build
  script:
    - cd tools/docker
    # Try to pull from dockerhub, build the container images if that fails
    - ./image-pull.sh || ./image-build.sh
    # Run clang-format and check there are no modified files by checking git status
    - ./clang-format.sh
    - git diff-index --exit-code HEAD
    - ./build.sh map -f CMAKE_BUILD_TYPE=Debug BUILD_TESTS=ON
    # Check that the AutoGenerated files are correct by checking git status
    - git update-index -q --refresh
    - git diff-index --exit-code HEAD
  tags:
    - shell
    - dockerbuild

run-tests:
  stage: test
  script:
    - cd tools/docker
    - ./run.sh -f -d --entrypoint "$PWD/../../../build/install/bin/tests/tlvf_test"
    - ./tests/test_flows.sh -v
  tags:
    - shell
    - dockerbuild
